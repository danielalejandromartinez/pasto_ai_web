{% extends "base.html" %}

{% block title %}Demostración Interactiva - Pasto.AI{% endblock %}

{% block content %}
<main class="conversational-container">
    
    <div class="conversation-body" id="conversation-body">
        <!-- Los mensajes se añadirán aquí con JavaScript -->
    </div>

    <div class="conversation-footer" id="conversation-footer">
        <div class="input-area">
            <textarea id="user-input" placeholder="Escribe tu problema aquí..." rows="1"></textarea>
            <button id="send-btn">➔</button>
        </div>
        <div class="response-buttons-container" id="response-buttons"></div>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ELEMENTOS ---
        const chatBody = document.getElementById('conversation-body');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const responseButtonsContainer = document.getElementById('response-buttons');
        const inputArea = document.querySelector('.input-area');

        // --- FUNCIONES DE UTILIDAD ---
        const wait = ms => new Promise(res => setTimeout(res, ms));

        function typeWriter(element, text) {
            return new Promise(resolve => {
                let i = 0;
                element.innerHTML = '';
                function type() {
                    if (i < text.length) {
                        if (text.charAt(i) === '<') {
                            const endIndex = text.indexOf('>', i);
                            element.innerHTML += text.substring(i, endIndex + 1);
                            i = endIndex + 1;
                        } else {
                            element.innerHTML += text.charAt(i);
                            i++;
                        }
                        setTimeout(type, 40);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        function createMessage(type, text = '') {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${type}`;
            const p = document.createElement('p');
            p.innerHTML = text;
            msgDiv.appendChild(p);
            chatBody.appendChild(msgDiv);
            chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' });
            return p;
        }

        function createResponseButtons(buttons) {
            responseButtonsContainer.innerHTML = '';
            inputArea.style.display = 'none';
            
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.className = 'response-btn';
                button.innerText = btnInfo.text;
                button.onclick = () => {
                    createMessage('patient', btnInfo.text);
                    btnInfo.onClick();
                };
                responseButtonsContainer.appendChild(button);
            });
        }
        
        // --- LÓGICA PRINCIPAL DE LA CONVERSACIÓN ---
        async function handleUserMessage() {
            const userText = userInput.value;
            if (userText.trim() === '') return;

            createMessage('patient', userText);
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;

            await wait(1000);
            const p1 = createMessage('agent');
            await typeWriter(p1, "Entendido. Analizando tu problema...");
            await wait(2000);

            const lowerCaseText = userText.toLowerCase();
            let agentResponseText = "";
            let agentSlug = null; // Guardamos el 'slug' del agente a mostrar
            let enableInputAfter = true; 

            if (lowerCaseText.includes('cita') || lowerCaseText.includes('agenda')) {
                agentResponseText = "Parece que tu mayor reto es la gestión de la agenda. Para eso, nuestro <strong>Agente de Agendamiento Inteligente</strong> es la solución perfecta. ¿Te gustaría ver cómo funciona?";
                agentSlug = 'agente-de-agendamiento-inteligente';
                enableInputAfter = false;
            } else if (lowerCaseText.includes('seguimiento') || lowerCaseText.includes('paciente') || lowerCaseText.includes('whatsapp')) {
                agentResponseText = "Entiendo, el seguimiento de pacientes consume mucho tiempo. Nuestro <strong>Asistente de Cuidado Post-Procedimiento</strong> está diseñado para resolver exactamente eso. ¿Quieres ver una simulación?";
                agentSlug = 'asistente-post-operatorio';
                enableInputAfter = false;
            } else if (lowerCaseText.includes('info') || lowerCaseText.includes('cliente') || lowerCaseText.includes('lead')) {
                agentResponseText = "Comprendo, atraer y filtrar nuevos clientes es clave. Nuestro <strong>Agente Calificador de Candidatos</strong> se especializa en eso. ¿Quieres ver una simulación de cómo convierte a un visitante curioso en un prospecto de calidad?";
                agentSlug = 'agente-calificador-de-candidatos';
                enableInputAfter = false;
            } else {
                agentResponseText = "Gracias por compartir tu desafío. Tenemos varios agentes que podrían ayudarte. Te recomiendo explorar nuestro <strong>catálogo de especialistas de IA</strong>. ¿Hay algún otro problema que quieras resolver?";
            }
            
            const p2 = createMessage('agent');
            await typeWriter(p2, agentResponseText);

            if (agentSlug) {
                // El botón ahora llama a la función global 'fadeOutAndNavigate'
                createResponseButtons([
                    { text: 'Sí, muéstrame la simulación', onClick: () => fadeOutAndNavigate(`/agente/${agentSlug}`) },
                    { text: 'No, gracias', onClick: () => { responseButtonsContainer.innerHTML = '<p style="color: #888; text-align: center;">De acuerdo. ¡Que tengas un buen día!</p>'; } }
                ]);
            }
            
            if (enableInputAfter) {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        async function startConversation() {
            await wait(1000);
            const p1 = createMessage('agent');
            await typeWriter(p1, "¡Hola! Soy el asistente de Pasto.AI. Gracias por tu interés.");
            
            await wait(500);
            const p2 = createMessage('agent');
            await typeWriter(p2, "Antes de mostrarte nuestras soluciones, me gustaría entender tu práctica. ¿Cuál es el mayor desafío que enfrentas en tu día a día?");
            
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }
        
        sendBtn.addEventListener('click', handleUserMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserMessage();
            }
        });
        
        userInput.disabled = true;
        sendBtn.disabled = true;
        startConversation();
    });
</script>
{% endblock %}